<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Attendance Report</title>

<!-- Excel Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 30px;
        background: #f7f7f7;
    }
    h1 {
        text-align: center;
    }
    .container {
        max-width: 900px;
        margin: auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 10px #ccc;
    }
    input[type="date"] {
        padding: 10px;
        width: 200px;
        font-size: 16px;
    }
    button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background: #0066ff;
        color: white;
        border: none;
        border-radius: 6px;
        margin-left: 10px;
    }
    #printBtn {
        display: none;
        margin-top: 20px;
        background: #333;
    }
    #excelPrintBtn {
        display: none;
        margin-top: 20px;
        background: #28a745;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
    }
    table, th, td {
        border: 1px solid #999;
    }
    th, td {
        padding: 12px;
        text-align: left;
    }
    th {
        background: #0066ff;
        color: white;
    }
    #noDataMsg {
        color: red;
        text-align: center;
        margin-top: 20px;
        font-weight: bold;
    }

    /* PRINT ONLY */
    @media print {
        body {
            margin: 0;
            padding: 0;
            background: white;
        }
        .container {
            box-shadow: none;
        }
        button, input[type="date"], label {
            display: none !important;
        }
        #printHeader {
            text-align: center;
            margin-bottom: 20px;
        }
    }
</style>
</head>
<body>

<div class="container">
    <h1>Attendance Report</h1>

    <label><strong>Select Date:</strong></label>
    <input type="date" id="dateInput">
    <button onclick="fetchAttendance()">Search</button>

    <button id="printBtn" onclick="printPage()">Print Report</button>
    <button id="excelPrintBtn" onclick="downloadExcelPrint()">Download Excel</button>

    <div id="printHeader" style="display:none;"></div>

    <div id="noDataMsg"></div>

    <table id="attendanceTable" style="display:none;">
        <thead>
            <tr>
                <th>Roll No</th>
                <th>Name</th>
                <th>Date & Time</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
let currentData = [];

// Fetch data
function fetchAttendance() {
    const date = document.getElementById("dateInput").value;
    if (!date) {
        alert("Please select a date");
        return;
    }

    const url = `http://localhost:9090/api/attendance/by-date?date=${date}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const table = document.getElementById("attendanceTable");
            const body = document.getElementById("tableBody");
            const msg = document.getElementById("noDataMsg");
            const printBtn = document.getElementById("printBtn");
            const excelPrintBtn = document.getElementById("excelPrintBtn");

            body.innerHTML = "";
            msg.innerHTML = "";
            currentData = data;

            if (data.length === 0) {
                table.style.display = "none";
                printBtn.style.display = "none";
                excelPrintBtn.style.display = "none";
                msg.innerHTML = "No attendance found for this date.";
                return;
            }

            table.style.display = "table";
            printBtn.style.display = "inline-block";
            excelPrintBtn.style.display = "inline-block";

            // Fill table
            data.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.registrationNo}</td>
                    <td>${row.name}</td>
                    <td>${row.timestamp.replace("T", " ")}</td>
                `;
                body.appendChild(tr);
            });

            // Prepare print header
            const adminName = localStorage.getItem("adminName") || "Admin";
            const generatedOn = new Date().toLocaleString();

            document.getElementById("printHeader").innerHTML = `
                <h2>Attendance Report</h2>
                <p>Date: <strong>${date}</strong></p>
                <p>Generated On: <strong>${generatedOn}</strong></p>
                <p>Generated By: <strong>${adminName}</strong></p>
                <br>
            `;
        })
        .catch(err => {
            console.error(err);
            alert("Error fetching attendance");
        });
}

// PRINT PAGE
function printPage() {
    document.getElementById("printHeader").style.display = "block";
    window.print();
    document.getElementById("printHeader").style.display = "none";
}

// -----------------------------
// ðŸ“Œ DOWNLOAD EXCEL (PRINT FORMAT)
// -----------------------------
function downloadExcelPrint() {
    if (currentData.length === 0) return;

    const date = document.getElementById("dateInput").value;
    const adminName = localStorage.getItem("adminName") || "Admin";
    const generatedOn = new Date().toLocaleString();

    let excelData = [
        ["Attendance Report"],
        ["Date:", date],
        ["Generated On:", generatedOn],
        ["Generated By:", adminName],
        [],
        ["Roll No", "Name", "Date & Time"]
    ];

    currentData.forEach(row => {
        excelData.push([
            row.registrationNo,
            row.name,
            row.timestamp.replace("T", " ")
        ]);
    });

    const sheet = XLSX.utils.aoa_to_sheet(excelData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, sheet, "Attendance");

    XLSX.writeFile(workbook, `Attendance_Report_${date}_PrintFormat.xlsx`);
}
</script>

</body>
</html>
